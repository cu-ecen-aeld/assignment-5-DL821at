#!/bin/sh
#
# S50dropbear - start/stop dropbear SSH server
#
case "$1" in
  start)
    echo "Starting dropbear SSH server after a short delay..."
    # Wait for the network to come up
    sleep 5

    # Ensure /etc/dropbear exists and is writable
    if [ ! -d /etc/dropbear ]; then
      mkdir -p /etc/dropbear
      chmod 755 /etc/dropbear
    fi

    # Check and generate RSA host key if missing
    if [ ! -f /etc/dropbear/dropbear_rsa_host_key ]; then
      echo "Generating RSA host key..."
      dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key
    fi
    # Similarly for ECDSA and ED25519:
    if [ ! -f /etc/dropbear/dropbear_ecdsa_host_key ]; then
      echo "Generating ECDSA host key..."
      dropbearkey -t ecdsa -f /etc/dropbear/dropbear_ecdsa_host_key
    fi
    if [ ! -f /etc/dropbear/dropbear_ed25519_host_key ]; then
      echo "Generating ED25519 host key..."
      dropbearkey -t ed25519 -f /etc/dropbear/dropbear_ed25519_host_key
    fi

    echo "Starting dropbear..."
    /usr/sbin/dropbear -R -E -p 22 &
    ;;
  stop)
    echo "Stopping dropbear SSH server..."
    killall dropbear
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac
exit 0
